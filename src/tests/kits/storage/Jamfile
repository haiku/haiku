SubDir HAIKU_TOP src tests kits storage ;

AddSubDirSupportedPlatforms libbe_test ;

UsePrivateHeaders storage ;

UnitTestLib libstoragetest.so
	: StorageKitTestAddon.cpp
		AppFileInfoTest.cpp
		BasicTest.cpp
		DataIOTest.cpp
		DirectoryTest.cpp
		EntryTest.cpp
		FindDirectoryTest.cpp
		FileTest.cpp
		MimeSnifferTest.cpp
		# MimeTypeTest.cpp
		NodeInfoTest.cpp
		NodeTest.cpp
		PathTest.cpp
		QueryTest.cpp
		ResourcesTest.cpp
		ResourceStringsTest.cpp
		StatableTest.cpp
		SymLinkTest.cpp
		TestApp.cpp
		VolumeTest.cpp
	: be [ TargetLibstdc++ ]
;

rule CopyResources {
	local files = $(1) ;
	local sourceDir = $(2) ;
	local targetDir = $(3) ;
	for file in $(files) {
		LOCATE on $(file) = $(sourceDir) ;
		local targetFile = $(file:G=tests!unittests) ;
		MakeLocate $(targetFile) : [ FDirName $(TARGET_UNIT_TEST_DIR) $(targetDir) ] ;
		File $(targetFile) : $(file) ;
		MODE on $(targetFile) = $(EXEMODE) ;
		MimeSet $(targetFile) ;
	}
}

# To run the tests some test files must be around.
{
	local sourceDir = src tests kits storage resources ;
	local files = elf elf-no-res pef pef-no-res ppc.rsrc x86.rsrc ;
	local sourceDirName = [ FDirName $(HAIKU_TOP) $(sourceDir) ] ;
	local grist = [ FGrist $(sourceDir) ] ;
	CopyResources $(files:G=$(grist)) : $(sourceDirName) : resources ;
	Depends libstoragetest.so : $(files:G=tests!unittests) ;
}

SubInclude HAIKU_TOP src tests kits storage disk_device ;
SubInclude HAIKU_TOP src tests kits storage testapps ;
SubInclude HAIKU_TOP src tests kits storage virtualdrive ;
